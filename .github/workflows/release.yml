name: Build and package for release

on:
  release:
    types: [published]

jobs:
  build:
    runs-on: windows-latest
    
    env:
      PRODUCT_NAME: CanIUse
      PROJECT_PATH: ./src/CanIUse/Community.PowerToys.Run.Plugin.CanIUse

    steps:

    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Extract version from release tag
      id: extract_version
      run: |
        $version = '${{ github.event.release.tag_name }}'
        echo "VERSION=$version" >> $env:GITHUB_ENV
      shell: powershell
        
    - name: Replace version token in plugin.json
      run: |
        (Get-Content '${{ env.PROJECT_PATH }}/plugin.json') -replace '\$\(Version\)', '${{ env.VERSION }}' | Set-Content '${{ env.PROJECT_PATH }}/plugin.json'
      shell: powershell

    - name: Package
      run: |
        dotnet pack -p:Platform=x64 -p:Version=${{ env.VERSION }}
        dotnet pack -p:Platform=ARM64 -p:Version=${{ env.VERSION }}

    - name: Upload x64 To Release
      uses: svenstaro/upload-release-action@v2
      with:
        repo_token: ${{secrets.GITHUB_TOKEN}}
        file: bin/${{ env.PRODUCT_NAME }}_${{ env.VERSION }}_x64.zip
        asset_name: ${{ env.PRODUCT_NAME }}_${{ env.VERSION }}.zip

    - name: Upload ARM64 To Release
      uses: svenstaro/upload-release-action@v2
      with:
        repo_token: ${{secrets.GITHUB_TOKEN}}
        file: bin/${{ env.PRODUCT_NAME }}_${{ env.VERSION }}_ARM64.zip
        asset_name: ${{ env.PRODUCT_NAME }}_${{ env.VERSION }}_ARM64.zip
